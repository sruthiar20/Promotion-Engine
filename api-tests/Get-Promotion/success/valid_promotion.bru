meta {
  name: valid_promotion_success
  type: http
  seq: 1
}

get {
  url: http://localhost:8080/admin/promotions/searchById?status=active&product-id=SKU-PRO-001&starts_at={{start_date}}&ends_at={{end_date}}
  auth: none
}

headers {
  Content-Type: application/json
  Accept: application/json
}

script:pre-request {
  // Set start date to tomorrow
  const tomorrow = new Date(Date.now() + 24 * 60 * 60 * 1000);
  bru.setVar("start_date", tomorrow.toISOString());
  
  // Set end date to 30 days from now
  const end_date = new Date(Date.now() + 30 * 24 * 60 * 60 * 1000);
  bru.setVar("end_date", end_date.toISOString());
}

assert {
  res.status: eq 200
}

tests {
  test("1.1 Should successfully retrieve promotion with valid parameters", function() {
    expect(res.status).to.equal(200,
      "Expected 200 OK status for valid promotion");
  });

  test("1.2 Should validate response headers", function() {
    expect(res.headers["content-type"]).to.match(/application\/json/,
      "Expected JSON content type in response");
  });

  test("1.3 Should have proper response structure", function() {
    expect(res.body).to.have.property('id');
    expect(res.body).to.have.property('code');
    expect(res.body).to.have.property('type');
    expect(res.body).to.have.property('value');
    expect(res.body).to.have.property('value_type');
    expect(res.body).to.have.property('starts_at');
    expect(res.body).to.have.property('ends_at');
    expect(res.body).to.have.property('status');
    expect(res.body).to.have.property('conditions').that.is.an('array');
  });

  test("1.4 Should have correct promotion status", function() {
    expect(res.body.status).to.equal("active",
      "Expected promotion status to be active");
  });

  test("1.5 Should validate date values are in correct format", function() {
    const starts_at = new Date(res.body.starts_at);
    const ends_at = new Date(res.body.ends_at);
    
    expect(isNaN(starts_at.getTime())).to.be.false,
      "starts_at should be a valid date";
    expect(isNaN(ends_at.getTime())).to.be.false,
      "ends_at should be a valid date";
    expect(ends_at.getTime()).to.be.greaterThan(starts_at.getTime(),
      "End date should be after start date");
  });

  test("1.6 Should validate product conditions", function() {
    // Check that the conditions array contains a product condition
    const productCondition = res.body.conditions.find(cond => cond.type === "product");
    expect(productCondition).to.exist;
    expect(productCondition.value).to.include("SKU-PRO-001",
      "Expected product condition to include the requested product ID");
  });
} 